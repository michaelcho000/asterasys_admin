/**
 * LLM Insights Analysis Script
 *
 * Claude APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ˆì¼€íŒ… ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * ê²°ê³¼ëŠ” data/processed/llm-insights.jsonì— ì €ì¥ë©ë‹ˆë‹¤.
 *
 * Usage: node scripts/analyzeLLMInsights.js
 */

const Anthropic = require('@anthropic-ai/sdk')
const fs = require('fs').promises
const path = require('path')
require('dotenv').config({ path: '.env.local' })

// ëª…ë ¹ì¤„ ì¸ìë¡œ ì›” ì„ íƒ (ê¸°ë³¸ê°’: 2025-09)
const targetMonth = process.argv[2] || '2025-09'
const DATA_DIR = path.join(__dirname, `../data/raw/${targetMonth}`)
const OUTPUT_FILE = path.join(__dirname, `../data/processed/llm-insights-${targetMonth}.json`)

// ì´ì „ ì›” ê³„ì‚° í—¬í¼
function getPreviousMonth(monthStr) {
  const [year, month] = monthStr.split('-').map(Number)
  const date = new Date(year, month - 1, 1)
  date.setMonth(date.getMonth() - 1)
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
}

// ë°ì´í„° íŒŒì¼ ë¡œë“œ (ì›”ê°„ ë¹„êµ í¬í•¨)
async function loadDataFiles() {
  console.log(`ğŸ“‚ ë°ì´í„° íŒŒì¼ ë¡œë“œ ì¤‘... (${targetMonth})`)

  const files = [
    'asterasys_total_data - blog_rank.csv',
    'asterasys_total_data - cafe_rank.csv',
    'asterasys_total_data - news_rank.csv',
    'asterasys_total_data - youtube_rank.csv',
    'asterasys_total_data - sale.csv',
    'asterasys_total_data - traffic.csv'
  ]

  const dataContents = {
    current: {},
    previous: null
  }

  // í˜„ì¬ ì›” ë°ì´í„° ë¡œë“œ
  for (const file of files) {
    const filePath = path.join(DATA_DIR, file)
    try {
      const content = await fs.readFile(filePath, 'utf-8')
      const dataType = file.split(' - ')[1].replace('.csv', '')
      dataContents.current[dataType] = content
      console.log(`  âœ“ ${dataType}`)
    } catch (error) {
      console.warn(`  âš  ${file} ë¡œë“œ ì‹¤íŒ¨:`, error.message)
    }
  }

  // ì´ì „ ì›” ë°ì´í„° ë¡œë“œ ì‹œë„
  const previousMonth = getPreviousMonth(targetMonth)
  const prevDataDir = path.join(__dirname, `../data/raw/${previousMonth}`)

  console.log(`\nğŸ“‚ ì´ì „ ì›” ë°ì´í„° í™•ì¸ ì¤‘... (${previousMonth})`)

  try {
    await fs.access(prevDataDir)
    dataContents.previous = {}

    for (const file of files) {
      const filePath = path.join(prevDataDir, file)
      try {
        const content = await fs.readFile(filePath, 'utf-8')
        const dataType = file.split(' - ')[1].replace('.csv', '')
        dataContents.previous[dataType] = content
        console.log(`  âœ“ ${dataType}`)
      } catch (error) {
        // ê°œë³„ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
      }
    }
    console.log('  â†’ ì´ì „ ì›” ë°ì´í„° ìˆìŒ (ë¹„êµ ë¶„ì„ ëª¨ë“œ)')
  } catch (error) {
    console.log('  â†’ ì´ì „ ì›” ë°ì´í„° ì—†ìŒ (ì²« ì›” ë¶„ì„ ëª¨ë“œ)')
  }

  return dataContents
}

// Claude APIë¡œ ë¶„ì„ ì‹¤í–‰
async function analyzeWithClaude(dataContents) {
  console.log('\nğŸ¤– Claude API ë¶„ì„ ì‹œì‘...')

  const anthropic = new Anthropic({
    apiKey: process.env.CLAUDE_API_KEY
  })

  const isFirstMonth = !dataContents.previous
  const data = dataContents.current

  // ì²« ì›” vs ì´í›„ ì›” í”„ë¡¬í”„íŠ¸ ë¶„ê¸°
  let prompt

  if (isFirstMonth) {
    // ì²« ì›”: 4ì„¹ì…˜ í†µì¼ êµ¬ì¡°
    prompt = `ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ ${targetMonth} ì˜ë£Œê¸°ê¸° ë§ˆì¼€íŒ… ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì •í™•í•œ JSON êµ¬ì¡°ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

# ì œê³µëœ ë°ì´í„°:

## Blog Rank Data
${data.blog_rank?.substring(0, 3000)}
...

## Cafe Rank Data
${data.cafe_rank?.substring(0, 3000)}
...

## News Rank Data
${data.news_rank?.substring(0, 3000)}
...

## YouTube Rank Data
${data.youtube_rank?.substring(0, 3000)}
...

## Sales Data
${data.sale}

## Traffic Data
${data.traffic}

# ìš°ë¦¬ ì œí’ˆ:
- ë¦¬í”„í…Œë¼, ì¿¨í˜ì´ì¦ˆ, ì¿¨ì†Œë‹‰

# ê²½ìŸì‚¬:
- ì¨ë§ˆì§€, ì¸ëª¨ë“œ, ìš¸ì„ë¼, ìŠˆë§í¬, ì˜¬ë¦¬ì§€ì˜¤, ë´ì„œí‹°, ì„¸ë¥´í”„, ë³¼ë‰´ë¨¸ ë“±

# JSON êµ¬ì¡° (ì •í™•íˆ ë”°ë¥¼ ê²ƒ):

\`\`\`json
{
  "month": "${targetMonth}",
  "isFirstMonth": true,
  "viral": {
    "current": {
      "title": "í˜„ì¬ ë¶„ì„",
      "content": "## ìš°ë¦¬ ì œí’ˆ í˜„í™©\\n\\n- **ì¿¨í˜ì´ì¦ˆ**: ë¸”ë¡œê·¸ 101ê±´(9ìœ„), ì¹´í˜ 789ê±´(2ìœ„, ì¡°íšŒìˆ˜ 45,450) - ì¹´í˜ ì¤‘ì‹¬ ê°•ì„¸\\n- **ë¦¬í”„í…Œë¼**: ë¸”ë¡œê·¸ 176ê±´(6ìœ„), ì¹´í˜ 503ê±´(4ìœ„, ì¡°íšŒìˆ˜ 28,225) - ê· í˜•ì  ë¶„í¬\\n- **ì¿¨ì†Œë‹‰**: ë¸”ë¡œê·¸ 34ê±´(8ìœ„), ì¹´í˜ 605ê±´(2ìœ„, ì¡°íšŒìˆ˜ 26,467) - ì¹´í˜ ì§‘ì¤‘ ì „ëµ\\n\\n## ê²½ìŸì‚¬ ëŒ€ë¹„ ë¶„ì„\\n\\n**ê³ ì£¼íŒŒ ì‹œì¥**: ì¨ë§ˆì§€(ë¸”ë¡œê·¸ 6,243ê±´, 1ìœ„), ì¸ëª¨ë“œ(4,142ê±´, 2ìœ„) ì••ë„ì  ìš°ìœ„. ì¿¨í˜ì´ì¦ˆëŠ” ë°œí–‰ëŸ‰ ê¸°ì¤€ ìµœí•˜ìœ„ê¶Œì´ë‚˜ **ì¹´í˜ì—ì„œ 2ìœ„**ë¡œ íŠ¹í™” ì˜ì—­ í™•ë³´\\n\\n**ì´ˆìŒíŒŒ ì‹œì¥**: ìš¸ì„ë¼(8,904ê±´, 1ìœ„), ìŠˆë§í¬(4,284ê±´, 2ìœ„) ì„ ë‘. ë¦¬í”„í…Œë¼ëŠ” 176ê±´ìœ¼ë¡œ 6ìœ„ì´ë‚˜ **ì¹´í˜ ì°¸ì—¬ë„(3,706 ëŒ“ê¸€) ë†’ìŒ**. ì¿¨ì†Œë‹‰ì€ ë¸”ë¡œê·¸ ìµœí•˜ìœ„(34ê±´)ì§€ë§Œ **ì¹´í˜ 2ìœ„** ë‹¬ì„±"
    },
    "strategy": {
      "title": "í–¥í›„ ì „ëµ",
      "content": "## ë‹¤ìŒ ë‹¬ ì§‘ì¤‘ ê³¼ì œ\\n\\n**1ìˆœìœ„: ì¹´í˜ ìš°ìœ„ ê·¹ëŒ€í™”**\\n- ì¿¨í˜ì´ì¦ˆ: 789â†’1,000ê±´ ëª©í‘œ (ì¨ë§ˆì§€ 1,258ê±´ ì¶”ê²©)\\n- ì¿¨ì†Œë‹‰: ì¡°íšŒìˆ˜ 26,467â†’40,000 ëª©í‘œ (ëŒ“ê¸€ ìœ ë„ ìº í˜ì¸)\\n- ë¦¬í”„í…Œë¼: 4ìœ„â†’3ìœ„ ë„ì•½ (ì›” 100ê±´ ì¦ëŒ€)\\n\\n**2ìˆœìœ„: ë¸”ë¡œê·¸ ì·¨ì•½ì  ë³´ì™„**\\n- ì¿¨í˜ì´ì¦ˆ: 101â†’250ê±´ (ë³‘ì› ë¸”ë¡œê·¸ 50ê°œ í™•ë³´)\\n- ì¿¨ì†Œë‹‰: 34â†’100ê±´ (ìµœí•˜ìœ„ íƒˆì¶œ)\\n- ë¦¬í”„í…Œë¼: ì¼ë°˜ ë¸”ë¡œê·¸ ë¹„ì¤‘ í™•ëŒ€ (75â†’150ê±´)\\n\\n**3ìˆœìœ„: ìœ íŠœë¸ŒÂ·ë‰´ìŠ¤ ì‹ ê·œ ì§„ì…**\\n- ì¿¨í˜ì´ì¦ˆ: ìœ íŠœë¸Œ 2â†’50ê±´ (ì‹œìˆ  ê³¼ì • ì˜ìƒ ì œì‘)\\n- ì¿¨ì†Œë‹‰: ë‰´ìŠ¤ 12â†’30ê±´ (ê¸°ìˆ  ë³´ë„ìë£Œ ë°°í¬)\\n- ë¦¬í”„í…Œë¼: ìœ íŠœë¸Œ 7â†’30ê±´ (ì „í›„ ì‚¬ë¡€ ì¤‘ì‹¬)\\n\\n## ê²½ìŸ ë¸Œëœë“œ ë²¤ì¹˜ë§ˆí‚¹\\n\\n**ì¨ë§ˆì§€ ì„±ê³µ ìš”ì¸**: ì¼ë°˜ ë¸”ë¡œê·¸ ë¹„ì¤‘ 53%ë¡œ ìì—° í™•ì‚° ìš°ìˆ˜, ìœ íŠœë¸Œ 1,010ê±´ìœ¼ë¡œ ì˜ìƒ ì½˜í…ì¸  ê°•ì„¸\\n\\n**ìš¸ì„ë¼ ê°•ì **: ë‰´ìŠ¤ 198ê±´ìœ¼ë¡œ ì‹ ë¢°ë„ ê¸°ë°˜ êµ¬ì¶•, ë¸”ë¡œê·¸ ì¼ë°˜ ë¹„ì¤‘ 51%ë¡œ Organic í™•ì‚° ì„±ê³µ\\n\\n**ìš°ë¦¬ì˜ ì ìš© ë°©ì•ˆ**: (1) ë³‘ì› ë¸”ë¡œê·¸ì—ì„œ ì¼ë°˜ ë¸”ë¡œê±° í˜‘ì—…ìœ¼ë¡œ ì „í™˜, (2) ìœ íŠœë¸Œ ì‹œìˆ  ì˜ìƒ ì›” 50ê±´ ì œì‘, (3) í•™íšŒ ë°œí‘œ ì¤‘ì‹¬ ë‰´ìŠ¤ PR ê°•í™”"
    },
    "situation": {
      "title": "í˜„ì¬ ìƒí™©",
      "content": "## ì±„ë„ë³„ Organic/Managed ë¹„ìœ¨ ë¶„ì„\\n\\n**ìš°ë¦¬ ì œí’ˆ (ì¶”ì • Organic 18%)**\\n- ë¸”ë¡œê·¸: ì¼ë°˜ ë¸”ë¡œê·¸ ë¹„ì¤‘ ë‚®ìŒ (ì¿¨í˜ì´ì¦ˆ 40%, ì¿¨ì†Œë‹‰ 41%, ë¦¬í”„í…Œë¼ 43%)\\n- ì¹´í˜: ë†’ì€ ì°¸ì—¬ë„ì´ë‚˜ **ì¡°íšŒìˆ˜ ëŒ€ë¹„ ëŒ“ê¸€ ë¹„ìœ¨ ê³¼ë‹¤** (ê´€ë¦¬í˜• ì˜ì‹¬)\\n- ë‰´ìŠ¤/ìœ íŠœë¸Œ: ìµœí•˜ìœ„ê¶Œ (ììƒì  í™•ì‚° ë¶€ì¡±)\\n\\n**ê²½ìŸì‚¬ í‰ê·  (ì¶”ì • Organic 35%)**\\n- ì¨ë§ˆì§€: ì¼ë°˜ ë¸”ë¡œê·¸ 53%, ìœ íŠœë¸Œ 1,010ê±´ìœ¼ë¡œ **ìì—° í™•ì‚° ìš°ìˆ˜**\\n- ìš¸ì„ë¼: ë‰´ìŠ¤ 198ê±´, ë¸”ë¡œê·¸ ì¼ë°˜ ë¹„ì¤‘ 51%ë¡œ **ì‹ ë¢°ë„ ê¸°ë°˜ êµ¬ì¶•**\\n\\n## ê²©ì°¨ ì›ì¸\\n\\nì¹´í˜ ì¤‘ì‹¬ ì „ëµì˜ **ì¦‰ê°ì  íš¨ê³¼**ëŠ” ìˆìœ¼ë‚˜, ì¥ê¸°ì  **ë¸Œëœë“œ ì¸ì§€ë„ í˜•ì„± ì·¨ì•½**. ê²€ìƒ‰ íŠ¸ë˜í”½ì€ ë†’ìœ¼ë‚˜(ì¿¨ì†Œë‹‰ 18,510, ë¦¬í”„í…Œë¼ 28,800) ì½˜í…ì¸  ë°œí–‰ëŸ‰ ë¯¸ë‹¬ë¡œ **ì „í™˜ìœ¨ ì €í•˜** ì¶”ì •"
    },
    "growth": {
      "title": "ì„±ì¥ ë°©í–¥",
      "content": "## í•µì‹¬ ì„±ì¥ ì „ëµ\\n\\n**1. ê²€ìƒ‰ëŸ‰-ì½˜í…ì¸  ê°­ í•´ì†Œ**\\n- ë¦¬í”„í…Œë¼: ì›”ê°„ ê²€ìƒ‰ 28,800 vs ë¸”ë¡œê·¸ 176ê±´ â†’ **200% ì¦ëŒ€ í•„ìš”**\\n- ì¿¨ì†Œë‹‰: ê²€ìƒ‰ 18,510 vs ë¸”ë¡œê·¸ 34ê±´ â†’ **300% ì¦ëŒ€ ì‹œê¸‰**\\n- ì¿¨í˜ì´ì¦ˆ: ê²€ìƒ‰ 11,390 vs ë¸”ë¡œê·¸ 101ê±´ â†’ ì ì • ìˆ˜ì¤€ ìœ ì§€\\n\\n**2. íŒë§¤-ë§ˆì¼€íŒ… ì—°ê³„ ê°•í™”**\\n- ì¿¨í˜ì´ì¦ˆ: ${targetMonth.split('-')[1]}ì›” íŒë§¤ 10ëŒ€, ì¹´í˜ 789ê±´ â†’ **ì „í™˜ìœ¨ 1.3% ê°œì„ **\\n- ë¦¬í”„í…Œë¼: ${targetMonth.split('-')[1]}ì›” íŒë§¤ 3ëŒ€, ë¸”ë¡œê·¸ 176ê±´ â†’ ë³‘ì› ë„¤íŠ¸ì›Œí¬ 30ê°œ í™•ëŒ€\\n- ì¿¨ì†Œë‹‰: ${targetMonth.split('-')[1]}ì›” íŒë§¤ 8ëŒ€, ì¹´í˜ 605ê±´ â†’ ROI ìµœì  ì±„ë„\\n\\n**3. Organic ë¹„ìœ¨ ë‹¨ê³„ì  ëª©í‘œ**\\n- í˜„ì¬ 18% â†’ ë‹¤ìŒ ë‹¬ ëª©í‘œ 22% (4%p ìƒìŠ¹)\\n- 3ê°œì›” í›„ ëª©í‘œ 28% (10%p ìƒìŠ¹)\\n- ë°©ë²•: ìœ íŠœë¸Œ ì›” 100ê±´, ì¼ë°˜ ë¸”ë¡œê·¸ ë¹„ì¤‘ 60% ì´ìƒ\\n\\n**4. í¬ë¡œìŠ¤ ì±„ë„ ì‹œë„ˆì§€**\\n- ì¹´í˜ ì¸ê¸° í† í”½ â†’ ë¸”ë¡œê·¸ ì‹¬ì¸µ ì½˜í…ì¸  ì „í™˜\\n- ìœ íŠœë¸Œ ì˜ìƒ â†’ ë‰´ìŠ¤ ë³´ë„ìë£Œ ì—°ê³„\\n- ë³‘ì› ë¸”ë¡œê·¸ â†’ ì¼ë°˜ ë¸”ë¡œê·¸ ìì—° í™•ì‚° ìœ ë„"
    }
  },
  "channels": {
    "cafe": {
      "insight": "**ì¿¨í˜ì´ì¦ˆ 789ê±´(2ìœ„)**, **ì¿¨ì†Œë‹‰ 605ê±´(2ìœ„)**ìœ¼ë¡œ ê°•ë ¥í•œ ì¹´í˜ ì¥ì•…ë ¥ ë³´ìœ . ë¦¬í”„í…Œë¼ 503ê±´(4ìœ„)ë„ ìƒìœ„ê¶Œ. ì¡°íšŒìˆ˜ í•©ê³„ 100,142ë¡œ ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¸ì—¬ë„ ìš°ìˆ˜í•˜ë‚˜, ì¨ë§ˆì§€(1,258ê±´, 1ìœ„)ì™€ 354ê±´ ê²©ì°¨ ì¡´ì¬. **ì „ëµ**: ì›” 100ê±´ì”© ì¦ëŒ€í•˜ì—¬ 3ê°œì›” ë‚´ 1ìœ„ ì¶”ê²©. ëŒ“ê¸€ ë¹„ìœ¨(ì¿¨í˜ì´ì¦ˆ 5,255ê°œ) í™œìš©í•´ ì§„ì •ì„± ì½˜í…ì¸  ì „í™˜ í•„ìš”. ì¹´í˜ê°€ ìœ ì¼í•œ ê°•ì  ì±„ë„ì´ë¯€ë¡œ **ì¡°íšŒìˆ˜ 40% ì¦ëŒ€** ëª©í‘œë¡œ ì§ˆì  ê°œì„  ë³‘í–‰. ê²½ìŸì‚¬ ëŒ€ë¹„ **Managed ì˜ì¡´ë„ ë‚®ì¶”ê¸°** ìœ„í•´ ìë°œì  í›„ê¸° ìœ ë„ ìº í˜ì¸ ì‹œê¸‰."
    },
    "blog": { "insight": "..." },
    "news": { "insight": "..." },
    "youtube": { "insight": "..." }
  }
}
\`\`\`

# ë§ˆí¬ë‹¤ìš´ ì‘ì„± ê·œì¹™:

1. **ë³¼ë“œì²´**: \`**í…ìŠ¤íŠ¸**\` (ê°•ì¡°í•  ì œí’ˆëª…, ìˆ˜ì¹˜)
2. **ëª©ë¡**: \`- í•­ëª©\` ë˜ëŠ” \`â€¢ í•­ëª©\`
3. **ì œëª©**: \`## ì œëª©\` (ì„¹ì…˜ êµ¬ë¶„)
4. **ì¤„ë°”ê¿ˆ**: \`\\n\\n\` (ë¬¸ë‹¨ êµ¬ë¶„)

# ì¤‘ìš” ì œì•½ì‚¬í•­:

1. **4ê°œ ì„¹ì…˜ ëª¨ë‘ í•„ìˆ˜** (current, strategy, situation, growth)
2. **í–¥í›„ ì „ëµ**ì—ëŠ” ë°˜ë“œì‹œ "ë‹¤ìŒ ë‹¬ ì§‘ì¤‘ ê³¼ì œ" + "ê²½ìŸ ë¸Œëœë“œ ë²¤ì¹˜ë§ˆí‚¹" í¬í•¨
3. **Q4, Q1, 2026 ê°™ì€ ì¥ê¸° ê³„íš ì ˆëŒ€ ê¸ˆì§€** - ë‹¤ìŒ ë‹¬ ê³„íšì—ë§Œ ì§‘ì¤‘
4. êµ¬ì²´ì  ìˆ˜ì¹˜ í¬í•¨ (ì˜ˆ: "789ê±´, 2ìœ„")
5. ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì‚¬ìš©
6. ${targetMonth} ë°ì´í„°ë§Œ ì‚¬ìš©`
  } else {
    // ì´í›„ ì›”: 4ì„¹ì…˜ í†µì¼ êµ¬ì¡° (ë¹„êµ ë¶„ì„)
    const previousMonth = getPreviousMonth(targetMonth)
    const prevData = dataContents.previous

    prompt = `ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ ${previousMonth}ì™€ ${targetMonth} ì˜ë£Œê¸°ê¸° ë§ˆì¼€íŒ… ë°ì´í„°ë¥¼ ë¹„êµ ë¶„ì„í•˜ì—¬ ì •í™•í•œ JSON êµ¬ì¡°ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

# ì œê³µëœ ë°ì´í„°:

## í˜„ì¬ ì›” (${targetMonth}):

### Blog Rank
${data.blog_rank?.substring(0, 2500)}
...

### Cafe Rank
${data.cafe_rank?.substring(0, 2500)}
...

### News Rank
${data.news_rank?.substring(0, 2500)}
...

### YouTube Rank
${data.youtube_rank?.substring(0, 2500)}
...

### Sales Data
${data.sale}

## ì „ì›” (${previousMonth}):

### Blog Rank
${prevData.blog_rank?.substring(0, 1500)}
...

### Cafe Rank
${prevData.cafe_rank?.substring(0, 1500)}
...

# ìš°ë¦¬ ì œí’ˆ:
- ë¦¬í”„í…Œë¼, ì¿¨í˜ì´ì¦ˆ, ì¿¨ì†Œë‹‰

# ê²½ìŸì‚¬:
- ì¨ë§ˆì§€, ì¸ëª¨ë“œ, ìš¸ì„ë¼, ìŠˆë§í¬, ì˜¬ë¦¬ì§€ì˜¤, ë´ì„œí‹°, ì„¸ë¥´í”„, ë³¼ë‰´ë¨¸ ë“±

# JSON êµ¬ì¡° (ì •í™•íˆ ë”°ë¥¼ ê²ƒ):

\`\`\`json
{
  "month": "${targetMonth}",
  "previousMonth": "${previousMonth}",
  "isFirstMonth": false,
  "viral": {
    "current": {
      "title": "í˜„ì¬ ë¶„ì„",
      "content": "## ìš°ë¦¬ ì œí’ˆ í˜„í™©\\n\\n- **ì¿¨í˜ì´ì¦ˆ**: ë¸”ë¡œê·¸ 132ê±´(+30.7%, 9ìœ„), ì¹´í˜ 598ê±´(-24.2%, 2â†’4ìœ„ í•˜ë½) - ì¹´í˜ ì•½ì„¸\\n- **ë¦¬í”„í…Œë¼**: ë¸”ë¡œê·¸ 358ê±´(+103.4%, 6ìœ„), ì¹´í˜ 430ê±´(-14.5%, 4ìœ„) - ë¸”ë¡œê·¸ ê¸‰ì„±ì¥\\n- **ì¿¨ì†Œë‹‰**: ë¸”ë¡œê·¸ 68ê±´(+100%, 9ìœ„), ì¹´í˜ 522ê±´(-13.7%, 2â†’3ìœ„) - ë¸”ë¡œê·¸ ê°œì„ \\n\\n## ê²½ìŸì‚¬ ëŒ€ë¹„ ë¶„ì„\\n\\n**ê³ ì£¼íŒŒ ì‹œì¥**: ì¨ë§ˆì§€ ë¸”ë¡œê·¸ 14,476ê±´(+131.9%, 1ìœ„), ì¹´í˜ 1,702ê±´(+35.3%, 1ìœ„)ë¡œ ê²©ì°¨ í™•ëŒ€. ì¿¨í˜ì´ì¦ˆëŠ” ì¹´í˜ì—ì„œ 2â†’4ìœ„ í•˜ë½\\n\\n**ì´ˆìŒíŒŒ ì‹œì¥**: ìš¸ì„ë¼ ë¸”ë¡œê·¸ 17,718ê±´(+99%, 1ìœ„), ì¹´í˜ 2,369ê±´(+79.3%, 1ìœ„). ë¦¬í”„í…Œë¼ëŠ” ë¸”ë¡œê·¸ +103.4% ê¸‰ì„±ì¥í–ˆìœ¼ë‚˜ ì¹´í˜ëŠ” -14.5% í•˜ë½"
    },
    "strategy": {
      "title": "í–¥í›„ ì „ëµ",
      "content": "## ë‹¤ìŒ ë‹¬ ì§‘ì¤‘ ê³¼ì œ\\n\\n**1ìˆœìœ„: ì¹´í˜ í•˜ë½ì„¸ ê¸´ê¸‰ ë°˜ì „**\\n- ì¿¨í˜ì´ì¦ˆ: 598â†’700ê±´ ëª©í‘œ (ì²´í—˜ë‹¨ 100ëª… ëª¨ì§‘)\\n- ì¿¨ì†Œë‹‰: 522â†’600ê±´ ëª©í‘œ (ëŒ“ê¸€ ì°¸ì—¬ ìº í˜ì¸)\\n- ë¦¬í”„í…Œë¼: 430â†’500ê±´ ëª©í‘œ (ì§„ì •ì„± í›„ê¸° ì´ë²¤íŠ¸)\\n\\n**2ìˆœìœ„: ë¸”ë¡œê·¸ ì„±ì¥ì„¸ ê°€ì†í™”**\\n- ë¦¬í”„í…Œë¼: +103.4% ëª¨ë©˜í…€ ìœ ì§€ (í˜‘ë ¥ ë³‘ì› 15ê°œ ì¶”ê°€)\\n- ì¿¨í˜ì´ì¦ˆ/ì¿¨ì†Œë‹‰: ë³‘ì›ë¸”ë¡œê·¸ ë¹„ì¤‘ í™•ëŒ€ (í”Œë ˆì´ìŠ¤ë¸”ë¡œê·¸ ì „í™˜)\\n\\n**3ìˆœìœ„: ìœ íŠœë¸ŒÂ·ë‰´ìŠ¤ ì‹ ê·œ íˆ¬ì**\\n- ìœ íŠœë¸Œ: ì‹œìˆ  ì˜ìƒ ì›” 50ê±´ ì œì‘\\n- ë‰´ìŠ¤: í•™íšŒ ë°œí‘œ ë³´ë„ìë£Œ ì›” 5ê±´\\n\\n## ê²½ìŸ ë¸Œëœë“œ ë²¤ì¹˜ë§ˆí‚¹\\n\\n**ì¨ë§ˆì§€ ì„±ê³µ ìš”ì¸**: ë¸”ë¡œê·¸ +131.9%, ì¹´í˜ +35.3% ë™ì‹œ ì„±ì¥ìœ¼ë¡œ ì „ ì±„ë„ ê°•ì„¸ ìœ ì§€\\n\\n**ìš¸ì„ë¼ ê°•ì **: ì¹´í˜ +79.3% ê¸‰ì¦, ë‰´ìŠ¤ 161ê±´ìœ¼ë¡œ ì‹ ë¢°ë„ ê¸°ë°˜ ë³‘í–‰\\n\\n**ìš°ë¦¬ì˜ ì ìš© ë°©ì•ˆ**: (1) ë¸”ë¡œê·¸ ì„±ì¥ì„¸ë¥¼ ì¹´í˜ë¡œ ì—°ê³„ (í¬ë¡œìŠ¤ í”„ë¡œëª¨ì…˜), (2) ì¨ë§ˆì§€ì²˜ëŸ¼ ì „ ì±„ë„ ë™ì‹œ íˆ¬ì ì „ëµ, (3) ìš¸ì„ë¼ì²˜ëŸ¼ ë‰´ìŠ¤ PRë¡œ ì‹ ë¢°ë„ êµ¬ì¶•"
    },
    "situation": {
      "title": "í˜„ì¬ ìƒí™©",
      "content": "## ì±„ë„ë³„ Organic/Managed ë¹„ìœ¨ ë¶„ì„\\n\\n**ìš°ë¦¬ ì œí’ˆ (ì¶”ì • Organic 20%)**\\n- ë¸”ë¡œê·¸: ì¼ë°˜ ë¸”ë¡œê·¸ ë¹„ì¤‘ ì¦ê°€ (ë¦¬í”„í…Œë¼ +103.4% ì„±ì¥ ê²¬ì¸)\\n- ì¹´í˜: ì „ì›” ëŒ€ë¹„ í‰ê·  -17.5% í•˜ë½ìœ¼ë¡œ Managed ì˜ì¡´ë„ ê°ì†Œ ì¶”ì„¸\\n- ìœ íŠœë¸Œ: ì‹ ê·œ ì§‘ê³„ë¡œ Organic í™•ì‚° ì‹œì‘\\n\\n**ê²½ìŸì‚¬ í‰ê·  (ì¶”ì • Organic 38%)**\\n- ì¨ë§ˆì§€: ë¸”ë¡œê·¸+ì¹´í˜ ë™ì‹œ ì„±ì¥ìœ¼ë¡œ **ì „ ì±„ë„ ê· í˜•**\\n- ìš¸ì„ë¼: ì¹´í˜ +79.3% ê¸‰ì¦, ë‰´ìŠ¤ 161ê±´ìœ¼ë¡œ **ì‹ ë¢°ë„ ìš°ìœ„**\\n\\n## ê²©ì°¨ ì›ì¸\\n\\në¸”ë¡œê·¸ ê¸‰ì„±ì¥(+100%)ì—ë„ ì¹´í˜ í•˜ë½(-17.5%)ìœ¼ë¡œ **ì±„ë„ ê°„ ë¶ˆê· í˜•** ì‹¬í™”. ê²½ìŸì‚¬ëŠ” ì „ ì±„ë„ ë™ì‹œ ì„±ì¥ ì „ëµ êµ¬ì‚¬ ì¤‘"
    },
    "growth": {
      "title": "ì„±ì¥ ë°©í–¥",
      "content": "## í•µì‹¬ ì„±ì¥ ì „ëµ\\n\\n**1. ë¸”ë¡œê·¸-ì¹´í˜ í¬ë¡œìŠ¤ ì±„ë„ ì‹œë„ˆì§€**\\n- ë¦¬í”„í…Œë¼ ë¸”ë¡œê·¸ 358ê±´(+103.4%) â†’ ì¹´í˜ ìœ ì… ì „í™˜ ìº í˜ì¸\\n- ë¸”ë¡œê·¸ ì¸ê¸° ì£¼ì œë¥¼ ì¹´í˜ í† ë¡  ì£¼ì œë¡œ ì—°ê³„\\n- ëª©í‘œ: ë¸”ë¡œê·¸ ì„±ì¥ì„¸ë¥¼ ì¹´í˜ë¡œ ì „ì´í•˜ì—¬ í•˜ë½ì„¸ ë°˜ì „\\n\\n**2. íŒë§¤-ë§ˆì¼€íŒ… ì—°ê³„ ê°•í™”**\\n- ë¦¬í”„í…Œë¼: ë¸”ë¡œê·¸ ê¸‰ì¦ â†’ íŒë§¤ ì „í™˜ìœ¨ ëª¨ë‹ˆí„°ë§\\n- ì¿¨í˜ì´ì¦ˆ: ì¹´í˜ í•˜ë½ â†’ íŒë§¤ ì˜í–¥ë„ ë¶„ì„ ë° ëŒ€ì‘\\n- ì¿¨ì†Œë‹‰: ROI ìµœì  ì±„ë„ ì§‘ì¤‘ íˆ¬ì\\n\\n**3. Organic ë¹„ìœ¨ ë‹¨ê³„ì  ëª©í‘œ**\\n- ${previousMonth} 18% â†’ ${targetMonth} 20% (2%p ìƒìŠ¹ ì¶”ì •)\\n- ë‹¤ìŒ ë‹¬ ëª©í‘œ 24% (ë¸”ë¡œê·¸+ìœ íŠœë¸Œ í™•ëŒ€)\\n- ë°©ë²•: ì¼ë°˜ ë¸”ë¡œê±° í˜‘ì—… í”„ë¡œê·¸ë¨, ìœ íŠœë¸Œ ì›” 100ê±´\\n\\n**4. ì „ ì±„ë„ ê· í˜• ì„±ì¥**\\n- ì¨ë§ˆì§€ ë²¤ì¹˜ë§ˆí‚¹: ë¸”ë¡œê·¸+ì¹´í˜ ë™ì‹œ íˆ¬ì\\n- ì¹´í˜ë§Œ ì˜ì¡´í•˜ì§€ ì•Šê³  ë‰´ìŠ¤/ìœ íŠœë¸Œ ë³‘í–‰\\n- ì±„ë„ë³„ ëª©í‘œ: ë¸”ë¡œê·¸ +50%, ì¹´í˜ +10%, ìœ íŠœë¸Œ +80%"
    }
  },
  "channels": {
    "cafe": {
      "insight": "**ìš°ë¦¬ ì œí’ˆ**: ì¿¨í˜ì´ì¦ˆ 598ê±´(-24.2%, 2â†’4ìœ„ í•˜ë½), ì¿¨ì†Œë‹‰ 522ê±´(-13.7%, 2â†’3ìœ„ í•˜ë½), ë¦¬í”„í…Œë¼ 430ê±´(-14.5%, 4ìœ„ ìœ ì§€). **ê²½ìŸì‚¬**: ì¨ë§ˆì§€ 1,702ê±´(+35.3%, 1ìœ„), ì¸ëª¨ë“œ 835ê±´(+11%, 2ìœ„), ìš¸ì„ë¼ 2,369ê±´(+79.3%, 1ìœ„)ê°€ ê²©ì°¨ í™•ëŒ€. **ìœ„ê¸° ìƒí™©**: 3ê°œ ì œí’ˆ ëª¨ë‘ ì „ì›” ëŒ€ë¹„ ë‘ ìë¦¿ìˆ˜ í•˜ë½, ì¨ë§ˆì§€/ìš¸ì„ë¼ ëŒ€ë¹„ 1/3~1/5 ìˆ˜ì¤€. **ì „ëµ**: (1) ì²´í—˜ë‹¨ ê¸´ê¸‰ ëª¨ì§‘ (ì¿¨í˜ì´ì¦ˆ 100ëª…, ì¿¨ì†Œë‹‰ 50ëª…), (2) ì‹¤ì‚¬ìš© í›„ê¸° ì´ë²¤íŠ¸ (ë¦¬í”„í…Œë¼ ëŒ“ê¸€ ì°¸ì—¬ ê²½í’ˆ), (3) ì˜ì‚¬ Q&A ì„¸ì…˜ ì£¼ 2íšŒ ìš´ì˜ìœ¼ë¡œ ì°¸ì—¬ë„ 20% í–¥ìƒ, (4) ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¨ë³„í™” ì½˜í…ì¸  (í†µì¦/íšŒë³µê¸°ê°„ ë¹„êµ ì¸í¬ê·¸ë˜í”½) ì§‘ì¤‘ ë°°í¬. ëª©í‘œ: ë‹¤ìŒ ë‹¬ í•©ì‚° 1,800ê±´ ë‹¬ì„±ìœ¼ë¡œ í•˜ë½ì„¸ ë°˜ì „."
    },
    "blog": { "insight": "..." },
    "news": { "insight": "..." },
    "youtube": { "insight": "..." }
  }
}
\`\`\`

# ë§ˆí¬ë‹¤ìš´ ì‘ì„± ê·œì¹™:

1. **ë³¼ë“œì²´**: \`**í…ìŠ¤íŠ¸**\` (ì œí’ˆëª…, ìˆ˜ì¹˜ ê°•ì¡°)
2. **ëª©ë¡**: \`- í•­ëª©\`
3. **ì œëª©**: \`## ì œëª©\`
4. **ì¤„ë°”ê¿ˆ**: \`\\n\\n\`

# ì¤‘ìš” ì œì•½ì‚¬í•­:

1. **4ê°œ ì„¹ì…˜ ëª¨ë‘ í•„ìˆ˜** (current, strategy, situation, growth)
2. **í–¥í›„ ì „ëµ**ì—ëŠ” ë°˜ë“œì‹œ "ë‹¤ìŒ ë‹¬ ì§‘ì¤‘ ê³¼ì œ" + "ê²½ìŸ ë¸Œëœë“œ ë²¤ì¹˜ë§ˆí‚¹" í¬í•¨
3. **Q4, Q1, 2026 ê°™ì€ ì¥ê¸° ê³„íš ì ˆëŒ€ ê¸ˆì§€** - ë‹¤ìŒ ë‹¬ ê³„íšì—ë§Œ ì§‘ì¤‘
4. ë°˜ë“œì‹œ ì¦ê°ë¥  í‘œì‹œ (ì˜ˆ: "+35.3%", "-14.5%")
5. ìˆœìœ„ ë³€í™” ëª…ì‹œ (ì˜ˆ: "2â†’4ìœ„")
6. ${previousMonth} ëŒ€ë¹„ ${targetMonth} ë³€í™” ì¤‘ì‹¬ ë¶„ì„`
  }

  const message = await anthropic.messages.create({
    model: "claude-sonnet-4-5-20250929",
    max_tokens: 20000,
    temperature: 1,
    messages: [
      {
        role: "user",
        content: prompt
      }
    ]
  })

  console.log('âœ“ ë¶„ì„ ì™„ë£Œ')
  return message.content[0].text
}

// ë¶„ì„ ê²°ê³¼ ì €ì¥
async function saveInsights(analysisResult, isFirstMonth) {
  console.log('\nğŸ’¾ ë¶„ì„ ê²°ê³¼ ì €ì¥ ì¤‘...')

  try {
    // JSON ì¶”ì¶œ (```json ... ``` ë¸”ë¡ì—ì„œ)
    const jsonMatch = analysisResult.match(/```json\n([\s\S]*?)\n```/)
    let insights

    if (jsonMatch) {
      insights = JSON.parse(jsonMatch[1])
    } else {
      // JSON ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ íŒŒì‹± ì‹œë„
      insights = JSON.parse(analysisResult)
    }

    // ë©”íƒ€ë°ì´í„° ì¶”ê°€
    insights.generatedAt = new Date().toISOString()
    insights.status = 'draft'
    insights.model = 'claude-sonnet-4-5-20250929'
    insights.month = targetMonth
    insights.isFirstMonth = isFirstMonth

    if (!isFirstMonth) {
      insights.previousMonth = getPreviousMonth(targetMonth)
    }

    // ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    const outputDir = path.dirname(OUTPUT_FILE)
    await fs.mkdir(outputDir, { recursive: true })

    // JSON ì €ì¥
    await fs.writeFile(
      OUTPUT_FILE,
      JSON.stringify(insights, null, 2),
      'utf-8'
    )

    console.log(`âœ“ ì €ì¥ ì™„ë£Œ: ${OUTPUT_FILE}`)
    console.log(`\nğŸ“Š ë¶„ì„ ê²°ê³¼ ìš”ì•½:`)
    console.log(`  - ëŒ€ìƒ ì›”: ${targetMonth}`)
    console.log(`  - ì²« ì›” ì—¬ë¶€: ${isFirstMonth ? 'Yes' : 'No'}`)
    if (!isFirstMonth) {
      console.log(`  - ë¹„êµ ì›”: ${insights.previousMonth}`)
    }
    console.log(`  - ì±„ë„ ìˆ˜: ${Object.keys(insights.channels || {}).length}`)

  } catch (error) {
    console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', error.message)

    // ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥
    const errorOutputFile = OUTPUT_FILE.replace('.json', '-raw.txt')
    await fs.writeFile(errorOutputFile, analysisResult, 'utf-8')
    console.log(`âš  ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥: ${errorOutputFile}`)

    throw error
  }
}

// ë©”ì¸ ì‹¤í–‰
async function main() {
  console.log('ğŸš€ LLM ì¸ì‚¬ì´íŠ¸ ë¶„ì„ ì‹œì‘\n')
  console.log('=' .repeat(60))

  try {
    // API í‚¤ í™•ì¸
    if (!process.env.CLAUDE_API_KEY) {
      throw new Error('CLAUDE_API_KEYê°€ .env.localì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')
    }

    // 1. ë°ì´í„° ë¡œë“œ
    const dataContents = await loadDataFiles()

    // 2. Claude API ë¶„ì„
    const analysisResult = await analyzeWithClaude(dataContents)

    // 3. ê²°ê³¼ ì €ì¥
    const isFirstMonth = !dataContents.previous
    await saveInsights(analysisResult, isFirstMonth)

    console.log('\n' + '='.repeat(60))
    console.log('âœ… ë¶„ì„ ì™„ë£Œ!')
    console.log('\në‹¤ìŒ ë‹¨ê³„:')
    console.log('  1. http://localhost:3000/insights-preview ì—ì„œ ê²°ê³¼ í™•ì¸')
    console.log('  2. í•„ìš”ì‹œ ìˆ˜ì • ë° ìŠ¹ì¸')
    console.log('  3. ìŠ¹ì¸ í›„ ì‹¤ì œ í˜ì´ì§€ì— ë°˜ì˜')

  } catch (error) {
    console.error('\nâŒ ì˜¤ë¥˜ ë°œìƒ:', error.message)
    console.error(error.stack)
    process.exit(1)
  }
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if (require.main === module) {
  main()
}

module.exports = { loadDataFiles, analyzeWithClaude, saveInsights }
